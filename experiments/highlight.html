<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>几何坐标点读：翻页+逐词增强版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { margin: 0; background: #2c2c2c; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
        .toolbar { width: 100%; background: #1a1a1a; padding: 12px; display: flex; justify-content: center; gap: 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #444; }
        .toolbar button { cursor: pointer; padding: 5px 15px; background: #444; color: white; border: none; border-radius: 4px; }
        .toolbar button:hover { background: #666; }
        
        #viewer-wrapper {
            position: relative;
            margin: 20px;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            background: white;
        }
        
        canvas { display: block; }

        #highlighter {
            position: absolute;
            background-color: rgba(255, 235, 59, 0.5);
            mix-blend-mode: multiply;
            pointer-events: none;
            display: none;
            border-radius: 2px;
            z-index: 10;
            border: 1px solid rgba(255, 193, 7, 0.8);
        }
        #loading-tip { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #333; display: none; }
    </style>
</head>
<body>

<div class="toolbar">
    <input type="file" id="file-input" accept="application/pdf">
    <button id="prev-btn">上一页</button>
    <span id="page-info">第 0 / 0 页</span>
    <button id="next-btn">下一页</button>
</div>

<div id="viewer-wrapper">
    <div id="loading-tip">渲染中...</div>
    <canvas id="pdf-canvas"></canvas>
    <div id="highlighter"></div>
</div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null;
    let pageNum = 1;
    let textItems = []; 
    let currentViewport = null;
    const synth = window.speechSynthesis;

    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const highlighter = document.getElementById('highlighter');
    const wrapper = document.getElementById('viewer-wrapper');
    const pageInfo = document.getElementById('page-info');
    const loadingTip = document.getElementById('loading-tip');

    // 1. 加载 PDF
    document.getElementById('file-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
        pageNum = 1;
        renderPage(pageNum);
    };

    // 2. 渲染页面核心逻辑
    async function renderPage(num) {
        if (synth.speaking) synth.cancel();
        loadingTip.style.display = 'block';
        highlighter.style.display = 'none';

        const page = await pdfDoc.getPage(num);
        const scale = 1.5; // 可根据需要调整缩放
        currentViewport = page.getViewport({ scale });

        canvas.height = currentViewport.height;
        canvas.width = currentViewport.width;
        wrapper.style.width = canvas.width + 'px';
        wrapper.style.height = canvas.height + 'px';

        await page.render({ canvasContext: ctx, viewport: currentViewport }).promise;

        const textContent = await page.getTextContent();
        textItems = textContent.items; 

        pageInfo.innerText = `第 ${num} / ${pdfDoc.numPages} 页`;
        loadingTip.style.display = 'none';
    }

    // 3. 几何点查与单词拆分逻辑
    wrapper.onclick = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        processClick(clickX, clickY);
    };

    function processClick(x, y) {
        highlighter.style.display = 'none';
        if (synth.speaking) synth.cancel();

        for (const item of textItems) {
            const tx = pdfjsLib.Util.transform(currentViewport.transform, item.transform);
            const itemX = tx[4];
            const itemY = tx[5] - (item.height * currentViewport.scale);
            const itemW = item.width * currentViewport.scale;
            const itemH = item.height * currentViewport.scale;

            // 检查是否点中此文本块
            if (x >= itemX && x <= itemX + itemW && y >= itemY && y <= itemY + itemH) {
                
                // --- 二次分词逻辑 ---
                const rawStr = item.str;
                // 按单词边界拆分（保留空格位置以便计算偏移）
                const words = rawStr.split(/(\s+)/);
                
                let accumulatedWidth = 0;
                // 使用 Canvas 测量字体宽度，确保比例与 PDF 一致
                ctx.font = `${item.height * currentViewport.scale}px sans-serif`;

                for (let word of words) {
                    const wordW = ctx.measureText(word).width;
                    const wordStartX = itemX + accumulatedWidth;

                    // 判断点击落在哪个词的范围内
                    if (x >= wordStartX && x <= wordStartX + wordW) {
                        const cleanWord = word.trim();
                        if (cleanWord.length > 0) {
                            showHighlight(wordStartX, itemY, wordW, itemH);
                            speak(cleanWord);
                            return; // 命中单词，结束检索
                        }
                    }
                    accumulatedWidth += wordW;
                }
                
                // 如果没点中具体词但点中了行，读整行（可选）
                showHighlight(itemX, itemY, itemW, itemH);
                speak(rawStr);
                break;
            }
        }
    }

    function showHighlight(x, y, w, h) {
        highlighter.style.left = x + 'px';
        highlighter.style.top = y + 'px';
        highlighter.style.width = w + 'px';
        highlighter.style.height = h + 'px';
        highlighter.style.display = 'block';
    }

    function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = /[\u4e00-\u9fa5]/.test(text) ? 'zh-CN' : 'en-US';
        synth.speak(utterance);
    }

    // 4. 翻页控制
    document.getElementById('prev-btn').onclick = () => {
        if (pdfDoc && pageNum > 1) {
            pageNum--;
            renderPage(pageNum);
        }
    };
    document.getElementById('next-btn').onclick = () => {
        if (pdfDoc && pageNum < pdfDoc.numPages) {
            pageNum++;
            renderPage(pageNum);
        }
    };
</script>

</body>
</html>